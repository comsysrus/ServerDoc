<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="keywords" content="TDM_Report">
        <link rel="stylesheet" type="text/css" media="screen" href="anim.css" title="report">
        <link rel="stylesheet" type="text/css" media="print" href="anim_NoFrames_print.css" title="report">
            <script src="tdmShowDetails.js" type="text/javascript"></script>
        <title>Toad Data Modeler - HTML Report</title>
    </head>

<body onLoad="getUrlItem()"><div class="mainContainer"><div id="headerContainer"><div id="header"><div class="title1"></div><div class="title2">Packages</div><div class="reportStats">12 января 2021 г. 20:53:10</div><div class="titleimage"><a href="https://www.quest.com/" target="_blank"><img src="Img/logo.png" alt="Made with Toad Data Modeler" border="0" /></a></div><div class="headerEnd"><p>&nbsp;</p></div></div><div id="navTop"><ul><li><a href="MInfo.html">Model Info</a></li><li><a href="MImage.html">ER Diagram</a></li><li><a href="Tables.html">Entities</a></li><li><a href="Columns.html">Attributes</a></li><li><a href="Indexes.html">Indexes</a></li><li><a href="Keys.html">Keys</a></li><li><a href="Relations.html">Relationships</a></li><li><a href="Triggers.html">Triggers</a></li><li class="selLi"><a href="Packages.html" class="selAnchor">Packages</a></li><li><a href="Sequences.html">Sequences</a></li></ul><div id="navTopEnd"><p>&nbsp;</p></div></div></div><div id="navCombo"><form name="allItems" action=""><select name="listOfItems" onChange="showSelected()"><option value="Pack_{A90DF47F-8153-4F23-87F1-07A8A944E505}">ORABET.ALFADIRECT_PACK</option><option value="Pack_{B89BD32E-E5E5-4A0B-95F9-1FC2F81E9BE5}">ORABET.JTRADE_PACK</option><option value="Pack_{AD16D824-565B-4D99-B763-B73B87958DB6}">ORABET.MAIL</option><option value="Pack_{A75AC9B1-EFF4-4C36-9CC1-3E51662019DD}">ORABET.MODELING_PACK</option><option value="Pack_{2132CD51-CD8C-43A9-85FD-07107E69EFBE}">ORABET.RESULT_PACK</option><option value="Pack_{7064F493-2FD8-4184-91FF-CA43026CC550}">ORABET.SYS_PAR_PACK</option><option value="Pack_{51866477-6623-4014-A3F1-044FE0360789}">ORABET.SYSTEM_SERV</option><option value="Pack_{96375814-F116-42D1-8243-A4CD1D5CEA61}">ORABET.TRADE_PACK</option></select></form><div id="navComboEnd"><p></p></div></div><div id="navLeft"><div id="bookmark"><ul><li><a onClick="return showDetail('Pack_{A90DF47F-8153-4F23-87F1-07A8A944E505}', this)">ORABET.ALFADIRECT_PACK</a></li><li><a onClick="return showDetail('Pack_{B89BD32E-E5E5-4A0B-95F9-1FC2F81E9BE5}', this)">ORABET.JTRADE_PACK</a></li><li><a onClick="return showDetail('Pack_{AD16D824-565B-4D99-B763-B73B87958DB6}', this)">ORABET.MAIL</a></li><li><a onClick="return showDetail('Pack_{A75AC9B1-EFF4-4C36-9CC1-3E51662019DD}', this)">ORABET.MODELING_PACK</a></li><li><a onClick="return showDetail('Pack_{2132CD51-CD8C-43A9-85FD-07107E69EFBE}', this)">ORABET.RESULT_PACK</a></li><li><a onClick="return showDetail('Pack_{7064F493-2FD8-4184-91FF-CA43026CC550}', this)">ORABET.SYS_PAR_PACK</a></li><li><a onClick="return showDetail('Pack_{51866477-6623-4014-A3F1-044FE0360789}', this)">ORABET.SYSTEM_SERV</a></li><li><a onClick="return showDetail('Pack_{96375814-F116-42D1-8243-A4CD1D5CEA61}', this)">ORABET.TRADE_PACK</a></li></ul><div id="bookmarkEnd"><p>&nbsp;</p></div></div></div><div class="separator" ></div><div class="container"><div id="content"><div id="Pack_{A90DF47F-8153-4F23-87F1-07A8A944E505}" class="item">
<a name = "Pack_{A90DF47F-8153-4F23-87F1-07A8A944E505}"></a>
<div class="caption1"><p>ORABET.ALFADIRECT_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br>   TYPE t_crs IS REF CURSOR;<br>  <br>   PROCEDURE getLastData15ByDate(paper_no IN VARCHAR2, begin_date IN DATE, end_date IN DATE,result OUT t_crs);<br>   PROCEDURE getLastData15(paper_no IN VARCHAR2,result OUT t_crs);<br>   PROCEDURE acceptAlert(alertId IN INTEGER);<br>   procedure importHistory(ptime_frame in integer, pticket in varchar2, pdt in date, popen in number, phigh in number, plow in number, pclose in number, pvolume in number, res out varchar2);<br>   procedure PutAlertNewData(pdt_from in date, pdt_to in date, ppaper_no in varchar2, ptime_frame in integer, pdt in date, pmsg in varchar2, poperation_type in varchar2);<br>   PROCEDURE getPriceByDate60(paper_no IN VARCHAR2,price_date IN DATE, price OUT t_crs);<br>   PROCEDURE CreateTimeFrameByTicker(Ticker in varchar2, PeriodMinutes in number, DateEndPeriod in date, EraseFlag in number);<br>   PROCEDURE CreateTimeFrame(EraseFlag in number);<br>   PROCEDURE SEND_LOG (TABLE_NAME in VARCHAR2, MSG in VARCHAR2, STATUS_MSG in varchar2);<br>   PROCEDURE SEND_LOG_WHO (TABLE_NAME in VARCHAR2, WHO in varchar2, MSG in VARCHAR2, STATUS_MSG in varchar2);<br>   PROCEDURE GetSytemSignalByStrategy (StrategyTrueName IN VARCHAR2, timeframe in varchar2, begin_date IN DATE, end_date IN DATE,result OUT t_crs);<br>   PROCEDURE NewBtStrategy (True_Name IN VARCHAR2, Pseudo_Name in varchar2, BT_STRATEGY_MODULE_ID in integer, Time_Frame in varchar2, Paper_No in integer, result OUT t_crs);<br>   procedure BTStrategyNextVal (result out integer);<br>   PROCEDURE getAssetByDate(paper_no IN integer, Time_Frame in integer, begin_date IN DATE, end_date IN DATE, DaysCount in Integer, result OUT t_crs); <br>   PROCEDURE getBtStrategyById(id IN integer, result OUT t_crs);  <br>   PROCEDURE getBtTuneById(id IN integer, result OUT t_crs);  <br>   PROCEDURE getBtParamById(id IN integer, result OUT t_crs);  <br>   PROCEDURE SetBtStatus(pId IN integer, pFinRes in Number, pStatus in varchar2, pCalc_Finished in Number);  <br>   PROCEDURE SetBtParamResult(pId IN integer, pParam_Name in varchar2, pFixedValue in Number); <br>   PROCEDURE ImportTickets(EraseFlag in number);      <br>   PROCEDURE CopyStrategyFromBT (pBT_STRATEGY_ID in integer, pRewrite in integer, pID OUT integer);  <br>   PROCEDURE NewStrategy (pTrue_Name IN VARCHAR2, pPseudo_Name in varchar2, pASSET in varchar2, pTIME_FRAME in varchar2, pPAPER_NO in varchar2, pLOTS in integer, pK in integer, pBCS_PORT in integer, pROUND in Integer, pOPEN_PORT in integer, pIS_NEED_CREATION in integer,  pID OUT integer);  <br>   PROCEDURE NewStrategyParam (pStrategy_id in integer, pParam_name in varchar2, pParam_Value in number,  pID OUT integer);  <br>   PROCEDURE CheckStrategyExists (pBT_STRATEGY_ID in integer, pID OUT integer);<br>   <br> END Alfadirect_Pack;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br>  PROCEDURE SEND_LOG (TABLE_NAME in VARCHAR2, MSG in VARCHAR2, STATUS_MSG in varchar2) IS<br>  sqltext varchar(500);<br>  time_from varchar(20);<br>  time_to varchar(20);<br>  LOG_ON number;<br>  BEGIN<br>      select O.LOG_ON into LOG_ON FROM ORABET.QUIK_TUNE O ;<br>      IF LOG_ON=1 <br>      THEN <br>        BEGIN <br>          select O.TIME_FROM into time_from FROM ORABET.QUIK_TUNE O ; <br>          select O.TIME_TO into time_TO FROM ORABET.QUIK_TUNE O ;<br>          IF (sysdate&gt;= TO_TIMESTAMP(to_char(sysdate,'dd.mm.yyyy')||time_from, 'DD.MM.YYYY HH24:MI:SS')) and (sysdate&lt;= TO_TIMESTAMP(to_char(sysdate,'dd.mm.yyyy')||time_to, 'DD.MM.YYYY HH24:MI:SS'))<br>          THEN<br>             sqltext := 'insert into '||TABLE_NAME|| '('||TABLE_NAME||'.LOG, '||TABLE_NAME||'.OPERATIONSTATUS)'||' values ('||''''||SEND_LOG.MSG||''''||','''||SEND_LOG.STATUS_MSG||''')';<br>          --   DBMS_OUTPUT.enable;<br>         --   dbms_output.put_line(sqltext);<br>             EXECUTE IMMEDIATE sqltext;                <br>          END IF;<br>        END;<br>      END IF;      <br>  END;<br> <br> PROCEDURE SEND_LOG_WHO (TABLE_NAME in VARCHAR2, WHO in VARCHAR2, MSG in VARCHAR2, STATUS_MSG in varchar2) IS<br>  sqltext varchar(500);<br>  time_from varchar(20);<br>  time_to varchar(20);<br>  LOG_ON number;<br>  BEGIN<br>      select O.LOG_ON into LOG_ON FROM ORABET.QUIK_TUNE O ;<br>      IF LOG_ON=1 <br>      THEN <br>        BEGIN <br>          select O.TIME_FROM into time_from FROM ORABET.QUIK_TUNE O ; <br>          select O.TIME_TO into time_TO FROM ORABET.QUIK_TUNE O ;<br>          IF (sysdate&gt;= TO_TIMESTAMP(to_char(sysdate,'dd.mm.yyyy')||time_from, 'DD.MM.YYYY HH24:MI:SS')) and (sysdate&lt;= TO_TIMESTAMP(to_char(sysdate,'dd.mm.yyyy')||time_to, 'DD.MM.YYYY HH24:MI:SS'))<br>          THEN<br>             sqltext := 'insert into '||TABLE_NAME|| '('||TABLE_NAME||'.LOG, '||TABLE_NAME||'.WHO, '||TABLE_NAME||'.OPERATIONSTATUS)'||' values ('||'''' || SEND_LOG_WHO.MSG || '''' || ',''' || SEND_LOG_WHO.WHO ||''',''' || SEND_LOG_WHO.STATUS_MSG ||''')';<br>             EXECUTE IMMEDIATE sqltext;                <br>          END IF;<br>        END;<br>      END IF;      <br>  END;<br> <br>   PROCEDURE getLastData15ByDate(paper_no IN VARCHAR2, begin_date IN DATE, end_date IN DATE,result OUT t_crs) IS<br>    BEGIN<br>    <br>     IF (TO_NUMBER(paper_no)&gt;0) or (TO_NUMBER(paper_no)&lt;-149)THEN<br>     OPEN result FOR <br>         SELECT paper_no, time as ttime, open, high, low, close, quantity FROM ORABET.arch_min15 WHERE paper_no= getLastData15ByDate.paper_no  AND time&gt;=begin_date AND time&lt;=end_date ORDER BY time ASC;<br>    ELSE <br>     OPEN result FOR <br>         SELECT paper_no, time as ttime, open, high, low, close, quantity FROM ORABET.arch_min15_2 WHERE paper_no= getLastData15ByDate.paper_no  AND time&gt;=begin_date AND time&lt;=end_date ORDER BY time ASC;<br>    END IF;<br>            <br>    END;<br>            <br>        <br>   PROCEDURE getLastData15(paper_no IN VARCHAR2,result OUT t_crs) IS<br>   BEGIN<br>   IF TO_NUMBER(paper_no)&gt;0 <br>   THEN<br>     OPEN result FOR <br>     SELECT paper_no, time as ttime, open, high, low, close, quantity <br>     FROM ORABET.arch_min15 <br>     WHERE time=(SELECT MAX(time) <br>                            FROM  ORABET.arch_min15 <br>                            WHERE paper_no=getLastData15.paper_no) AND <br>                            paper_no=getLastData15.paper_no;<br>   ELSE <br>     OPEN result FOR <br>         SELECT paper_no, time as ttime, open, high, low, close, quantity <br>         FROM ORABET.arch_min15_2 <br>         WHERE time=(SELECT MAX(time) <br>                              FROM ORABET.arch_min15_2 <br>                              WHERE paper_no=getLastData15.paper_no) AND <br>                              paper_no=getLastData15.paper_no;<br>   END IF;  <br>   END;<br> <br>  <br>  <br> PROCEDURE acceptAlert(alertId IN INTEGER) IS<br>  BEGIN<br>   DELETE FROM ORABET.ALERT_TABLE WHERE ID=alertId;<br>  -- sys.DBMS_ALERT.SIGNAL('MDIListener','');<br>   commit;<br>  END;  <br>    <br>   <br> procedure PutAlertNewData(pdt_from in date, pdt_to in date, ppaper_no in varchar2, ptime_frame in integer, pdt in date, pmsg in varchar2, poperation_type in varchar2) is<br>   sig varchar2 (200);<br> begin<br>   insert  into ORABET.alertnewdata (dt_from, dt_to, paper_no, time_frame, dt, msg)  values (pdt_from, pdt_to, ppaper_no, ptime_frame, pdt, pmsg);<br>   sys.DBMS_ALERT.SIGNAL('MDIListenerNewData', pmsg);    <br> end;  <br>   <br> procedure importHistory(ptime_frame in integer, pticket in varchar2, pdt in date, popen in number, phigh in number, plow in number, pclose in number, pvolume in number, res out varchar2) is<br>  <br>  paper_no integer;<br>  <br>  begin<br>    <br>   res := 'ok';<br>   paper_no := 0;  <br> <br>   select ORABET.BT_PAPERS.PAPER_NO into paper_no<br>   from ORABET.BT_PAPERS<br>   where ORABET.BT_PAPERS.P_CODE = pticket; <br>  <br> <br>    if paper_no&gt;0 and ptime_frame=1 then<br>    begin<br>    insert <br>    into orabet.arch_min1 (paper_no, time, open, high, low, close, quantity)  values (paper_no, pdt, popen, phigh, plow, pclose, pvolume);<br>    EXCEPTION<br>    WHEN DUP_VAL_ON_INDEX THEN<br>     res := pticket|| ' DUP_VAL_ON_INDEX';<br>    end;<br>    end if;<br>    <br>    if paper_no&gt;0 and ptime_frame=5 then<br>    begin<br>    insert <br>    into orabet.arch_min5 (paper_no, time, open, high, low, close, quantity)  values (paper_no, pdt, popen, phigh, plow, pclose, pvolume);<br>    EXCEPTION<br>    WHEN DUP_VAL_ON_INDEX THEN<br>     res := pticket|| ' DUP_VAL_ON_INDEX';<br>    end;<br>    end if;<br>  <br>    if paper_no&gt;0 and ptime_frame=15 then<br>    begin<br>    insert <br>    into orabet.arch_min15 (paper_no, time, open, high, low, close, quantity)  values (paper_no, pdt, popen, phigh, plow, pclose, pvolume);<br>    EXCEPTION<br>    WHEN OTHERS  THEN<br>     res := pticket|| ' DUP_VAL_ON_INDEX';<br>    end;<br>    end if;<br> <br>    if paper_no&gt;0 and ptime_frame=30 then<br>    begin<br>    insert <br>    into orabet.arch_min30 (paper_no, time, open, high, low, close, quantity)  values (paper_no, pdt, popen, phigh, plow, pclose, pvolume);<br>    EXCEPTION<br>    WHEN DUP_VAL_ON_INDEX THEN<br>     res := pticket|| ' DUP_VAL_ON_INDEX';<br>    end;<br>    end if;<br> <br>    <br>    if paper_no&gt;0 and ptime_frame=60 then<br>    begin<br>    insert <br>    into orabet.arch_min60 (paper_no, time, open, high, low, close, quantity)  values (paper_no, pdt, popen, phigh, plow, pclose, pvolume);<br>    EXCEPTION<br>    WHEN DUP_VAL_ON_INDEX THEN<br>     res := pticket|| ' DUP_VAL_ON_INDEX';<br>    end;<br>    end if;<br> <br>   end;  <br> <br> PROCEDURE getPriceByDate60(paper_no IN VARCHAR2,price_date IN DATE, price OUT t_crs) IS<br>   BEGIN<br>    OPEN price FOR SELECT paper_no, time as ttime, open, high, low, close, quantity FROM orabet.arch_min60 <br>    WHERE time=price_date AND paper_no=getPriceByDate60.paper_no;<br>   END;   <br> <br> PROCEDURE CreateTimeFrame(EraseFlag in number) is<br> -- Select names from QUIK and make timeframe tickers for every ticker for 1, 5, 15, 60 minutes <br> dt date;<br> v_ticker varchar(100);<br> CURSOR Ticker_List IS<br> 	   SELECT Distinct ORABET.QUIK.TICKER FROM ORABET.QUIK;<br> begin<br>   DBMS_OUTPUT.enable;<br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','====================================================================', ''); <br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','START BY ORABET.QUIK_SCHED_JOB', '');<br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','====================================================================', ''); <br> <br>   dt := sysdate;<br>   FOR v IN Ticker_List LOOP<br>   v_ticker := v.TICKER;<br> <br> ------------------------------------------------------------------------  <br>   if (to_char(dt,'mi')='00')<br>   then <br>     ORABET.ALFADIRECT_PACK.CREATETIMEFRAMEBYTICKER(v_ticker, 60, dt, 0); <br>   end if;            <br> ------------------------------------------------------------------------<br>     if (    (to_char(dt,'mi')='00') or<br>             (to_char(dt,'mi')='15') or<br>             (to_char(dt,'mi')='30') or<br>             (to_char(dt,'mi')='45')<br>             )<br>     then <br>         ORABET.ALFADIRECT_PACK.CREATETIMEFRAMEBYTICKER(v_ticker, 15, dt, 0); <br>     end if;            <br> ------------------------------------------------------------------------<br>     if (to_char(dt,'mi')='00') or (mod(to_number(to_char(dt,'mi')),5)=0)       <br>     then <br>         ORABET.ALFADIRECT_PACK.CREATETIMEFRAMEBYTICKER(v_ticker, 5, dt, 0); <br>     end if;            <br> ------------------------------------------------------------------------  <br>     -- starts every 1 min becouse scheduler 1 min<br>     ORABET.ALFADIRECT_PACK.CREATETIMEFRAMEBYTICKER(v_ticker, 1,  dt, 0);<br>   END LOOP;		<br> <br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','====================================================================', ''); <br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','STOP', '');<br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrame','====================================================================', ''); <br> <br> end;<br>  <br> PROCEDURE CreateTimeFrameByTicker(Ticker in varchar2, PeriodMinutes in number, DateEndPeriod in date, EraseFlag in number) is<br> v_high   NUMBER;<br> v_low    NUMBER;<br> v_open   number;<br> v_close  number;<br> v_volume number;<br> fromDt   date;<br> toDt     date;<br> p_ticker varchar2(100);<br> paper_no number;<br> dt date;<br> <br> BEGIN<br> <br>  DBMS_OUTPUT.enable;<br> -- dbms_output.put_line('Start CreateTimeFrameByTicker '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod);<br> -- insert into ORABET.QUIK_LOG (LOG,DT) values ('Start '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, sysdate);<br> -- commit;<br> --fromdt := dt - interval PeriodMinuts/24/60  minute;<br> <br> dt := CreateTimeFrameByTicker.DateEndPeriod;<br> fromdt := dt - PeriodMinutes/24/60;<br> todt := dt; <br> <br> v_open := null;<br> v_close := null;<br> v_low := null;<br> v_high := null;<br> v_volume := null;<br> <br> Begin<br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 195', 'Start Create TimeFrame '||PeriodMinutes||' min for '||CreateTimeFrameByTicker.ticker,'');<br>  <br>  v_open := null;<br>  SELECT DISTINCT FIRST_VALUE(q.LAST_PRICE) OVER (ORDER BY q.dt ASC RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) into v_open   <br>  FROM ORABET.QUIK q <br>  WHERE (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br>  EXCEPTION<br>         WHEN TOO_MANY_ROWS <br>         THEN    <br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 204','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||' Too many rows', 'ERROR');<br>             commit;<br>         WHEN OTHERS <br>         THEN begin <br>                 v_open := null;<br>                 ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;         <br> end;<br> if not (v_open is null) <br> then  <br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 215','Calc OPEN for '||CreateTimeFrameByTicker.ticker||' '||v_open, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 217', 'Calc OPEN for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL'); <br> end if;     <br> begin  <br> v_close := null;      <br> SELECT DISTINCT FIRST_VALUE(q.LAST_PRICE) OVER (ORDER BY q.dt DESC RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) into v_close   <br> FROM ORABET.QUIK q <br> WHERE (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br> EXCEPTION<br>         WHEN OTHERS <br>         THEN begin <br>                v_close := null;<br>                ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 228','EXCEPTION Calc CLOSE for '||CreateTimeFrameByTicker.ticker||' NO DATA FOUND', 'ERROR');<br>                commit;<br>              end;  <br> end;<br> if not (v_close is null) <br> then  <br>  ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 234', 'Calc CLOSE for '||CreateTimeFrameByTicker.ticker||' '||v_close, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 236', 'Calc CLOSE for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL'); <br> end if;    <br> <br> begin <br> v_low := null;        <br> select min(q.LAST_PRICE) into v_low<br> from ORABET.QUIK q<br> where (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br> EXCEPTION<br>         WHEN OTHERS <br>         THEN begin <br>                v_low := null;<br>                ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 248','EXCEPTION  Calc LOW for '||CreateTimeFrameByTicker.ticker||'NO DATA FOUND', 'ERROR');<br>                commit;<br>              end;  <br> end;<br> <br> if not (v_low is null) <br> then  <br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 255', 'Calc LOW for '||CreateTimeFrameByTicker.ticker||' '||v_low, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 257', 'Calc LOW for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL');<br> end if;    <br> <br> <br> begin<br> v_high := null;<br> select max(q.LAST_PRICE) into v_high<br> from ORABET.QUIK q<br> where (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br> EXCEPTION<br>         WHEN OTHERS<br>         THEN begin <br>                v_high := null;<br>                ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 270','EXCEPTION Calc HIGH for '||CreateTimeFrameByTicker.ticker||' NO DATA FOUND', 'ERROR');<br>                commit;<br>              end;  <br> end; <br> <br> if not (v_high is null) <br> then  <br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 277', 'Calc HIGH for '||CreateTimeFrameByTicker.ticker||' '||v_high, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 279', 'Calc HIGH for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL');  <br> end if;    <br> <br> begin<br> v_volume := null;<br> select sum(q.QUANTITY) into v_volume<br> from ORABET.QUIK q<br> where (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br> EXCEPTION<br>         WHEN OTHERS <br>         THEN begin <br>                v_volume := null;<br>                ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 291','EXCEPTION Calc VOLUME for '||CreateTimeFrameByTicker.ticker||' NO DATA FOUND', 'ERROR');<br>                commit;<br>              end;  <br> end;<br> <br> if not (v_volume is null) <br> then  <br>    ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 298', 'Calc VOLUME for '||CreateTimeFrameByTicker.ticker||' '||v_volume, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 300', 'Calc VOLUME for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL');<br> end if;    <br> <br> paper_no := null;  <br> p_ticker := CreateTimeFrameByTicker.ticker;<br> if CreateTimeFrameByTicker.ticker = 'SBER' THEN  p_ticker :='SBER'; end if;<br> <br> if not (p_ticker is null) <br> then <br>   begin<br>      select distinct p.paper_no into paper_no <br>      from ORABET.BT_PAPERS p<br>      where p.P_CODE=p_ticker and paper_no&gt;1000; -- ATTENTION ### need to change(paper_no and asset must be uniqui) <br>      EXCEPTION<br>      WHEN OTHERS<br>      THEN begin <br>              ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 316','EXCEPTION SEARCHING PAPER_NO for '||CreateTimeFrameByTicker.ticker||' NO DATA FOUND', 'ERROR');<br>              commit; <br>           end;  <br>   end; <br> else  <br>    ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 321','ERROR SEARCHING PAPER_NO for '||CreateTimeFrameByTicker.ticker||' TICKER NOT FOUND IN TABLE ORABET.PSEUDOSYSTEM', 'ERROR');  <br> end if;<br> <br> if not (paper_no is null) <br> then  <br>    ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 326', 'SEARCHING PAPER_NO for '||CreateTimeFrameByTicker.ticker||' '||paper_no, 'OK');<br> else<br>   ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 328', 'SEARCHING PAPER_NO for '||CreateTimeFrameByTicker.ticker||' '||' is NULL', 'FOUND NULL'); <br> end if; <br> <br> ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 331', 'Try start to insert data '||CreateTimeFrameByTicker.ticker||' '||paper_no||' TimeFrame '||CreateTimeFrameByTicker.periodminutes||' min', '');<br>  <br> <br> if (CreateTimeFrameByTicker.periodminutes = 1) <br> then begin         <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 336', 'Start insert to orabet.arch_min1 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>          if not (paper_no is null) and not (v_open is null) and not (v_high is null) and not (v_low is null) and not (v_close is null) and not (v_volume is null)  <br>          then<br>          begin <br>             insert into orabet.arch_min1(orabet.arch_min1.paper_no, orabet.arch_min1.time, orabet.arch_min1.open, orabet.arch_min1.high, orabet.arch_min1.low, orabet.arch_min1.close, orabet.arch_min1.quantity) <br>             values(paper_no, todt, v_open, v_high, v_low, v_close, v_volume);<br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 342', 'Inserted to orabet.arch_min1 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'OK');<br>             commit;<br>             EXCEPTION<br>             WHEN OTHERS THEN <br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 346', 'EXCEPTION CAN NOT INSERT to orabet.arch_min1 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'ERROR');<br>          end;<br>          else ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 348', 'FOUND ZERO VALUES. CANCEL to insert to orabet.arch_min1 '||CreateTimeFrameByTicker.ticker||' '||paper_no, ''); <br>          end if; <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 350', 'End insert to orabet.arch_min1 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>       end;   <br> end if;<br> <br> <br> if (CreateTimeFrameByTicker.periodminutes = 5) <br> then begin         <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 357', 'Start insert to orabet.arch_min5 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>          if not (paper_no is null) and not (v_open is null) and not (v_high is null) and not (v_low is null) and not (v_close is null) and not (v_volume is null)  <br>          then<br>          begin <br>             insert into orabet.arch_min5(orabet.arch_min5.paper_no, orabet.arch_min5.time, orabet.arch_min5.open, orabet.arch_min5.high, orabet.arch_min5.low, orabet.arch_min5.close, orabet.arch_min5.quantity) <br>             values(paper_no, todt, v_open, v_high, v_low, v_close, v_volume);<br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 363', 'Inserted to orabet.arch_min5 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'OK');<br>             commit;<br>             EXCEPTION<br>             WHEN OTHERS THEN <br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 367', 'EXCEPTION CAN NOT INSERT to orabet.arch_min5 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'ERROR');<br>          end;<br>          else ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 369', 'FOUND ZERO VALUES. CANCEL to insert to orabet.arch_min5 '||CreateTimeFrameByTicker.ticker||' '||paper_no, ''); <br>          end if; <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 371', 'End insert to orabet.arch_min5 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>       end;   <br> end if;<br> <br> <br> <br> <br> if (CreateTimeFrameByTicker.periodminutes = 15) <br> then begin         <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 380', 'Start insert to orabet.arch_min15 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>          if not (paper_no is null) and not (v_open is null) and not (v_high is null) and not (v_low is null) and not (v_close is null) and not (v_volume is null)  <br>          then<br>          begin <br>             insert into orabet.arch_min15(orabet.arch_min15.paper_no, orabet.arch_min15.time, orabet.arch_min15.open, orabet.arch_min15.high, orabet.arch_min15.low, orabet.arch_min15.close, orabet.arch_min15.quantity) <br>             values(paper_no, todt, v_open, v_high, v_low, v_close, v_volume);<br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 386', 'Inserted to orabet.arch_min15 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'OK');<br>             commit;<br>             EXCEPTION<br>             WHEN OTHERS THEN <br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 390', 'EXCEPTION CAN NOT INSERT to orabet.arch_min15 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'ERROR');<br>          end;<br>          else ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 392', 'FOUND ZERO VALUES. CANCEL to insert to orabet.arch_min15 '||CreateTimeFrameByTicker.ticker||' '||paper_no, ''); <br>          end if; <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 394', 'End insert to orabet.arch_min15 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>       end;   <br> end if;<br> <br> <br> <br> if (CreateTimeFrameByTicker.periodminutes = 60) <br> then begin         <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 402', 'Start insert to orabet.arch_min60 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>          if not (paper_no is null) and not (v_open is null) and not (v_high is null) and not (v_low is null) and not (v_close is null) and not (v_volume is null)  <br>          then<br>          begin <br>             insert into orabet.arch_min60(orabet.arch_min60.paper_no, orabet.arch_min60.time, orabet.arch_min60.open, orabet.arch_min60.high, orabet.arch_min60.low, orabet.arch_min60.close, orabet.arch_min60.quantity) <br>             values(paper_no, todt, v_open, v_high, v_low, v_close, v_volume);<br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 408', 'Inserted to orabet.arch_min60 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'OK');<br>             commit;<br>             EXCEPTION<br>             WHEN OTHERS THEN <br>             ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 412', 'EXCEPTION CAN NOT INSERT to orabet.arch_min60 '||CreateTimeFrameByTicker.Ticker||' '||PeriodMinutes||' '||CreateTimeFrameByTicker.DateEndPeriod, 'ERROR');<br>          end;<br>          else ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 414', 'FOUND ZERO VALUES. CANCEL to insert to orabet.arch_min60 '||CreateTimeFrameByTicker.ticker||' '||paper_no, ''); <br>          end if; <br>          ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 416', 'End insert to orabet.arch_min60 '||CreateTimeFrameByTicker.ticker||' '||paper_no, '');<br>       end;   <br> end if;<br> <br> <br> -- clear table QUIK after made TimeFrame<br> if CreateTimeFrameByTicker.eraseflag = 1<br> then<br>   begin<br>      delete from ORABET.QUIK q<br>      where (q.dt&gt;fromDt) and (q.dt &lt;= toDt) and (q.ticker=CreateTimeFrameByTicker.ticker);<br>      ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 427', 'CLEAR TABLE ORABET.QUIK FROM '||to_char(fromDt)||' '||to_char(toDt), '');<br>      EXCEPTION  WHEN OTHERS THEN ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 428', 'EXCEPTION CAN NOT CLEAR TABLE ORABET.QUIK FROM '||to_char(fromDt)||' '||to_char(toDt), 'ERROR');       <br>   end;         <br> end if;<br> <br> <br> ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.QUIK_LOG','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 433', 'STOP Create TimeFrame '||PeriodMinutes||' min for '||CreateTimeFrameByTicker.ticker,'');<br>  <br> end;<br> <br> PROCEDURE GetSytemSignalByStrategy (StrategyTrueName IN VARCHAR2, timeframe in varchar2, begin_date IN DATE, end_date IN DATE, result OUT t_crs) is<br> begin<br>    OPEN result FOR <br>    <br>    SELECT s.* <br>    from ORABET.SYSTEM_SIGNAL2 s <br>    where <br>          s.SIGNAL_DATE&gt;=begin_date AND <br>          s.SIGNAL_DATE&lt;=end_date and <br>          s.STRATEGY_TRUE_NAME = GetSytemSignalByStrategy.StrategyTrueName <br>    ORDER BY s.SIGNAL_DATE ASC; <br> end;<br> <br>  PROCEDURE NewBtStrategy (True_Name IN VARCHAR2, Pseudo_Name in varchar2, BT_STRATEGY_MODULE_ID in integer, Time_Frame in varchar2, Paper_No in integer, result OUT t_crs) is <br>  begin <br>    insert into orabet.bt_strategy(orabet.bt_strategy.TRUE_NAME,orabet.bt_strategy.PSEUDO_NAME, orabet.bt_strategy.BT_STRATEGY_MODULE_ID,  orabet.bt_strategy.TIME_FRAME, orabet.bt_strategy.PAPER_NO)<br>    values (NewBtStrategy.True_Name, NewBtStrategy.Pseudo_Name, NewBtStrategy.BT_STRATEGY_MODULE_ID, NewBtStrategy.Time_Frame, NewBtStrategy.Paper_No);<br>    OPEN result FOR <br>    SELECT s.* <br>    from orabet.bt_strategy s ; <br>  end;<br> procedure BTStrategyNextVal (result out integer) is<br> begin <br>    result := ORABET.BT_STRATEGY_SEQ.nextval;<br> end;<br> <br> PROCEDURE getAssetByDate(paper_no IN integer, Time_Frame in integer, begin_date IN DATE, end_date IN DATE,  DaysCount in Integer, result OUT t_crs) is <br>   toDt   date;<br>   fromDt date;<br>   maxDt  date;<br>   --CTable Table;<br> begin<br> <br>  if Time_Frame = 1 <br>  then <br>  begin<br>   <br>     if getAssetByDate.DaysCount&gt;0 then <br>     begin <br>       select max(ORABET.ARCH_MIN1.TIME) into maxDt<br>       from ORABET.ARCH_MIN1; <br>       toDt := maxDt;<br>       fromDt := maxDt - getAssetByDate.DaysCount;<br>     end; else <br>     begin<br>       toDt := end_date;<br>       fromDt := begin_date;<br>     end;<br>     end if; <br> <br>  <br>     open result for <br>     SELECT * <br>     from  ORABET.ARCH_MIN1 <br>     where ORABET.ARCH_MIN1.PAPER_NO = getAssetByDate.paper_no and<br>           ORABET.ARCH_MIN1.TIME &gt;= fromDt and ORABET.ARCH_MIN1.TIME &lt;= toDt<br>     order by ORABET.ARCH_MIN1.TIME;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>  end; <br>  end if; <br>  <br>  <br>  if Time_Frame = 5 <br>  then <br>  begin<br>   <br>     if getAssetByDate.DaysCount&gt;0 then <br>     begin <br>       select max(ORABET.ARCH_MIN5.TIME) into maxDt<br>       from ORABET.ARCH_MIN5; <br>       toDt := maxDt;<br>       fromDt := maxDt - getAssetByDate.DaysCount;<br>     end; else <br>     begin<br>       toDt := end_date;<br>       fromDt := begin_date;<br>     end;<br>     end if; <br> <br>  <br>     open result for <br>     SELECT * <br>     from  ORABET.ARCH_MIN5 <br>     where ORABET.ARCH_MIN5.PAPER_NO = getAssetByDate.paper_no and<br>           ORABET.ARCH_MIN5.TIME &gt;= fromDt and ORABET.ARCH_MIN5.TIME &lt;= toDt<br>     order by ORABET.ARCH_MIN5.TIME;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>  end; <br>  end if;  <br>  <br>   if Time_Frame = 15 <br>  then <br>  begin<br>   <br>     if getAssetByDate.DaysCount&gt;0 then <br>     begin <br>       select max(ORABET.ARCH_MIN15.TIME) into maxDt<br>       from ORABET.ARCH_MIN15; <br>       toDt := maxDt;<br>       fromDt := maxDt - getAssetByDate.DaysCount;<br>     end; else <br>     begin<br>       toDt := end_date;<br>       fromDt := begin_date;<br>     end;<br>     end if; <br> <br>  <br>     open result for <br>     SELECT * <br>     from  ORABET.ARCH_MIN15 <br>     where ORABET.ARCH_MIN15.PAPER_NO = getAssetByDate.paper_no and<br>           ORABET.ARCH_MIN15.TIME &gt;= fromDt and ORABET.ARCH_MIN15.TIME &lt;= toDt<br>     order by ORABET.ARCH_MIN15.TIME;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>  end; <br>  end if; <br> <br>   if Time_Frame = 30 <br>  then <br>  begin<br>   <br>     if getAssetByDate.DaysCount&gt;0 then <br>     begin <br>       select max(ORABET.ARCH_MIN30.TIME) into maxDt<br>       from ORABET.ARCH_MIN30; <br>       toDt := maxDt;<br>       fromDt := maxDt - getAssetByDate.DaysCount;<br>     end; else <br>     begin<br>       toDt := end_date;<br>       fromDt := begin_date;<br>     end;<br>     end if; <br> <br>  <br>     open result for <br>     SELECT * <br>     from  ORABET.ARCH_MIN30 <br>     where ORABET.ARCH_MIN30.PAPER_NO = getAssetByDate.paper_no and<br>           ORABET.ARCH_MIN30.TIME &gt;= fromDt and ORABET.ARCH_MIN30.TIME &lt;= toDt<br>     order by ORABET.ARCH_MIN30.TIME;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>  end; <br>  end if; <br>  <br>  if Time_Frame = 60 <br>  then <br>  begin<br>   <br>     if getAssetByDate.DaysCount&gt;0 then <br>     begin <br>       select max(ORABET.ARCH_MIN60.TIME) into maxDt<br>       from ORABET.ARCH_MIN60; <br>       toDt := maxDt;<br>       fromDt := maxDt - getAssetByDate.DaysCount;<br>     end; else <br>     begin<br>       toDt := end_date;<br>       fromDt := begin_date;<br>     end;<br>     end if; <br> <br>  <br>     open result for <br>     SELECT * <br>     from  ORABET.ARCH_MIN60 <br>     where ORABET.ARCH_MIN60.PAPER_NO = getAssetByDate.paper_no and<br>           ORABET.ARCH_MIN60.TIME &gt;= fromDt and ORABET.ARCH_MIN60.TIME &lt;= toDt<br>     order by ORABET.ARCH_MIN60.TIME;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>  end; <br>  end if; <br>  <br>                      <br> end;<br> <br>   PROCEDURE getBtStrategyById(id IN integer, result OUT t_crs) is<br>   begin<br>     open result for <br>     SELECT *<br>            FROM ORABET.BT_STRATEGY<br>            INNER JOIN ORABET.BT_STRATEGY_MODULE ON (ORABET.BT_STRATEGY_MODULE.ID = ORABET.BT_STRATEGY.BT_STRATEGY_MODULE_ID)<br>     where ORABET.BT_STRATEGY.ID = getBtStrategyById.id;<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>   end;<br> <br>  PROCEDURE getBtTuneById(id IN integer, result OUT t_crs) is<br>   begin<br>     open result for <br>     SELECT * <br>     from  ORABET.BT_GA_TUNE <br>     where  ORABET.BT_GA_TUNE.ID in (Select ORABET.BT_STRATEGY.BT_GA_TUNE_ID from ORABET.BT_STRATEGY where ORABET.BT_STRATEGY.ID=getBtTuneById.id) ;    <br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>   end;<br> <br>  PROCEDURE getBtParamById(id IN integer, result OUT t_crs) is<br>   begin<br>     open result for <br>     SELECT * <br>     from  ORABET.BT_PARAMS <br>     where  ORABET.BT_PARAMS.STRATEGY_ID = getBtParamById.id;    <br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br>   end;<br> <br> PROCEDURE SetBtStatus(pId IN integer, pFinRes in Number, pStatus in varchar2, pCalc_Finished in Number) is<br> Begin<br>     Update ORABET.BT_STRATEGY <br>     set ORABET.BT_STRATEGY.FinRes = pFinRes, ORABET.BT_STRATEGY.Status = pStatus, ORABET.BT_STRATEGY.Calc_Finished = pCalc_Finished   <br>     where  ORABET.BT_STRATEGY.ID = pId;    <br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br> <br> end;<br>  <br> PROCEDURE SetBtParamResult(pId IN integer, pParam_Name in varchar2, pFixedValue in Number) is <br> Begin<br>     Update ORABET.BT_Params <br>     set ORABET.BT_Params.ValueFixed = pFixedValue  <br>     where ORABET.BT_Params.STRATEGY_ID = pId and ORABET.BT_Params.Param_Name = pParam_Name;    <br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;<br> <br> end;<br> <br> PROCEDURE ImportTickets(EraseFlag in number) is<br> -- Select names from QUIK and make timeframe tickers for every ticker for 1, 5, 15, 60 minutes <br> dt date;<br> v_ticket varchar(100);<br> paper_no integer;<br> CURSOR Ticker_List IS<br> 	   SELECT Distinct ORABET.arch_import.TICKET FROM ORABET.arch_import;<br> begin<br>   DBMS_OUTPUT.enable;<br>   FOR v IN Ticker_List LOOP<br>   <br> begin  <br>   v_ticket := v.TICKET;<br>   PAPER_NO := 0;<br>   Select  ORABET.BT_PAPERS.PAPER_NO into PAPER_NO <br>   from ORABET.BT_PAPERS<br>   where ORABET.BT_PAPERS.P_CODE = v_ticket;<br>   <br>   if paper_no = 0 then<br>     Delete from ORABET.arch_import <br>     where ORABET.arch_import.TICKET = v_ticket;     <br>   end if; <br>    <br>  <br>   if Paper_no&lt;&gt;0  then <br>   begin<br> <br> <br>   insert into ORABET.ARCH_min1 <br>   select distinct * from (<br>   with t1 as (select ORABET.BT_PAPERS.paper_no, orabet.arch_import.TIME, orabet.arch_import.OPEN, orabet.arch_import.HIGH, orabet.arch_import.LOW, orabet.arch_import.CLOSE, orabet.arch_import.QUANTITY <br>               FROM ORABET.ARCH_import, ORABET.BT_PAPERS <br>               where ORABET.ARCH_import.TIME_FRAME=1 and ORABET.BT_PAPERS.P_CODE=ORABET.ARCH_import.TICKET)<br>   select t1.* from t1      <br>   LEFT OUTER JOIN ORABET.ARCH_min1 ON t1.paper_no = ORABET.ARCH_min1.paper_no  and t1.time = ORABET.ARCH_MIN1.TIME<br>   where ORABET.ARCH_min1.PAPER_NO is null);<br>   <br>   insert into ORABET.ARCH_min5 <br>   select distinct * from (<br>   with t1 as (select ORABET.BT_PAPERS.paper_no, orabet.arch_import.TIME, orabet.arch_import.OPEN, orabet.arch_import.HIGH, orabet.arch_import.LOW, orabet.arch_import.CLOSE, orabet.arch_import.QUANTITY <br>               FROM ORABET.ARCH_import, ORABET.BT_PAPERS <br>               where ORABET.ARCH_import.TIME_FRAME=5 and ORABET.BT_PAPERS.P_CODE=ORABET.ARCH_import.TICKET)<br>   select t1.* from t1      <br>   LEFT OUTER JOIN ORABET.ARCH_min5 ON t1.paper_no = ORABET.ARCH_min5.paper_no  and t1.time = ORABET.ARCH_MIN5.TIME<br>   where ORABET.ARCH_min5.PAPER_NO is null);<br> <br>   insert into ORABET.ARCH_min15 <br>   select distinct * from (<br>   with t1 as (select ORABET.BT_PAPERS.paper_no, orabet.arch_import.TIME, orabet.arch_import.OPEN, orabet.arch_import.HIGH, orabet.arch_import.LOW, orabet.arch_import.CLOSE, orabet.arch_import.QUANTITY <br>               FROM ORABET.ARCH_import, ORABET.BT_PAPERS <br>               where ORABET.ARCH_import.TIME_FRAME=15 and ORABET.BT_PAPERS.P_CODE=ORABET.ARCH_import.TICKET)<br>   select t1.* from t1      <br>   LEFT OUTER JOIN ORABET.ARCH_min15 ON t1.paper_no = ORABET.ARCH_min15.paper_no  and t1.time = ORABET.ARCH_MIN15.TIME<br>   where ORABET.ARCH_min15.PAPER_NO is null);<br>  <br>   insert into ORABET.ARCH_min30 <br>   select distinct * from (<br>   with t1 as (select ORABET.BT_PAPERS.paper_no, orabet.arch_import.TIME, orabet.arch_import.OPEN, orabet.arch_import.HIGH, orabet.arch_import.LOW, orabet.arch_import.CLOSE, orabet.arch_import.QUANTITY <br>               FROM ORABET.ARCH_import, ORABET.BT_PAPERS <br>               where ORABET.ARCH_import.TIME_FRAME=30 and ORABET.BT_PAPERS.P_CODE=ORABET.ARCH_import.TICKET)<br>   select t1.* from t1      <br>   LEFT OUTER JOIN ORABET.ARCH_min30 ON t1.paper_no = ORABET.ARCH_min30.paper_no  and t1.time = ORABET.ARCH_MIN30.TIME<br>   where ORABET.ARCH_min30.PAPER_NO is null);<br>   <br>   insert into ORABET.ARCH_min60 <br>   select distinct * from (<br>   with t1 as (select ORABET.BT_PAPERS.paper_no, orabet.arch_import.TIME, orabet.arch_import.OPEN, orabet.arch_import.HIGH, orabet.arch_import.LOW, orabet.arch_import.CLOSE, orabet.arch_import.QUANTITY <br>               FROM ORABET.ARCH_import, ORABET.BT_PAPERS <br>               where ORABET.ARCH_import.TIME_FRAME=60 and ORABET.BT_PAPERS.P_CODE=ORABET.ARCH_import.TICKET)<br>   select t1.* from t1      <br>   LEFT OUTER JOIN ORABET.ARCH_min60 ON t1.paper_no = ORABET.ARCH_min60.paper_no  and t1.time = ORABET.ARCH_MIN60.TIME<br>   where ORABET.ARCH_min60.PAPER_NO is null);   <br> <br> end;<br> end if;<br> <br>   delete <br>   from ORABET.ARCH_Import <br>   where ORABET.arch_import.TICKET = v_ticket;       <br>    <br> end;      <br>   END LOOP;		<br> <br> commit;<br> <br> <br> end;<br> <br> <br>  PROCEDURE NewStrategy (pTrue_Name IN VARCHAR2, pPseudo_Name in varchar2, pASSET in varchar2, pTIME_FRAME in varchar2, pPAPER_NO in varchar2, pLOTS in integer, pK in integer, pBCS_PORT in integer, pROUND in Integer, pOPEN_PORT in integer, pIS_NEED_CREATION in integer, pID OUT integer) is<br>  newid integer;<br>  begin<br>    newid := ORABET.PSEUDO_SYSTEM_SEQ.nextval; <br>    pID := newid; <br>    insert into ORABET.PSEUDO_SYSTEM (ORABET.PSEUDO_SYSTEM.Id, True_Name, Pseudo_Name, ASSET, TIME_FRAME, PAPER_NO, LOTS, ORABET.PSEUDO_SYSTEM.K, BCS_PORT, ORABET.PSEUDO_SYSTEM.ROUND, OPEN_PORT, IS_NEED_CREATION)<br>    values (newid, pTrue_Name, pPseudo_Name, pASSET, pTIME_FRAME, pPAPER_NO, pLOTS, pK, pBCS_PORT, pROUND, pOPEN_PORT, pIS_NEED_CREATION);<br>    EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                pID := -1;<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                 COMMIT ;<br>              end;   <br>    <br>    commit;<br>  --  OPEN result FOR <br>  --  SELECT s.* <br>  --  from ORABET.PSEUDO_SYSTEM s ; <br>  <br>       <br>  end; <br> <br> PROCEDURE CopyStrategyFromBT (pBT_STRATEGY_ID in integer, pRewrite in integer, pID OUT integer) is<br> -- копирует стратегию из bt_strategey в pseudo_system с парметрами<br>  newid integer;<br>  StCount integer;<br>  TrName varchar2 (20);<br>  PsName varchar2 (20);<br>  pAsset varchar2 (20);<br>  pTime_frame varchar2 (20);<br>  pPaper_no varchar2 (20);<br>  bstId integer;<br>  stId integer;<br>  NewIDSysParam integer;<br> begin<br>     stId := ORABET.PSEUDO_SYSTEM_SEQ.nextval; <br>    <br>     StCount := 0; <br>     <br>     select ORABET.BT_STRATEGY.TRUE_NAME, ORABET.BT_STRATEGY.PSEUDO_NAME into TrName, PsName<br>     from ORABET.BT_STRATEGY<br>     where ORABET.BT_STRATEGY.ID = pBT_STRATEGY_ID;<br> <br>     select count (ORABET.PSEUDO_SYSTEM.ID) into StCount <br>     from ORABET.PSEUDO_SYSTEM<br>     where ORABET.PSEUDO_SYSTEM.TRUE_NAME = TrName and ORABET.PSEUDO_SYSTEM.PSEUDO_NAME = PsName;<br>     <br>  -- перезапись   <br>     if StCount&gt;0 and pRewrite=1 <br>     then begin<br>        <br>              select ORABET.PSEUDO_SYSTEM.ID into stId <br>              from ORABET.PSEUDO_SYSTEM<br>              where ORABET.PSEUDO_SYSTEM.TRUE_NAME = TrName and ORABET.PSEUDO_SYSTEM.PSEUDO_NAME = PsName;<br>          <br>              SELECT 'min'||ORABET.BT_STRATEGY.TIME_FRAME,<br>                     ORABET.BT_STRATEGY.PAPER_NO,<br>                     ORABET.BT_STRATEGY.BT_STRATEGY_MODULE_ID,<br>                     ORABET.BT_PAPERS.P_CODE <br>              into pTime_frame,<br>                   pPaper_no,<br>                   bstId,<br>                   pAsset<br>              FROM ORABET.BT_STRATEGY  <br>              INNER JOIN ORABET.BT_PAPERS ON (ORABET.BT_STRATEGY.PAPER_NO = ORABET.BT_PAPERS.PAPER_NO)<br>              where ORABET.BT_STRATEGY.ID = pBT_STRATEGY_ID; <br>              <br>              Update ORABET.PSEUDO_SYSTEM <br>              set ORABET.PSEUDO_SYSTEM.ASSET = pAsset,<br>                  ORABET.PSEUDO_SYSTEM.PAPER_NO = pPaper_no,<br>                  ORABET.PSEUDO_SYSTEM.BT_STRATEGY_MODULE_ID = bstId,<br>                  ORABET.PSEUDO_SYSTEM.TIME_FRAME = pTime_frame<br>              where ORABET.PSEUDO_SYSTEM.ID = stId;    <br>              -- параметры<br>              -- удаляем старые параметры и добавляем заново<br>              delete from ORABET.SYS_PARAMS s <br>              where s.STRATEGY_ID = stId;<br>              commit;<br>            -- NewIdSysParam := ORABET.SYS_PARAMS_SEQ.nextval; <br>              <br>              insert into ORABET.SYS_PARAMS (PARAM_NAME, PARAM_VALUE, STRATEGY_ID) <br>              (select<br>              nvl(ORABET.BT_PARAMS.PARAM_NAME,'PARAM_NAME'), <br>              nvl(ORABET.BT_PARAMS.VALUEFIXED,0), <br>              stId<br>              from ORABET.BT_PARAMS<br>              where ORABET.BT_PARAMS.STRATEGY_ID = CopyStrategyFromBT.pBT_STRATEGY_ID);           <br>           end;<br>     end if;<br>   -- конец перезапись     <br>     <br>  -- Новый    <br>     if StCount=0 <br>     then begin<br>        <br>        insert into ORABET.PSEUDO_SYSTEM (<br>        ORABET.PSEUDO_SYSTEM.Id, <br>        True_Name, <br>        Pseudo_Name, <br>        ASSET, <br>        TIME_FRAME, <br>        PAPER_NO, <br>        LOTS, <br>        ORABET.PSEUDO_SYSTEM.K, <br>        BCS_PORT, <br>        ORABET.PSEUDO_SYSTEM.ROUND, <br>        OPEN_PORT, <br>        IS_NEED_CREATION, <br>        ORABET.PSEUDO_SYSTEM.BT_STRATEGY_MODULE_ID)<br>        SELECT <br>        <br>        stId,<br>        ORABET.BT_STRATEGY.TRUE_NAME,<br>        ORABET.BT_STRATEGY.PSEUDO_NAME,<br>        ORABET.BT_PAPERS.P_CODE,<br>        'min'||ORABET.BT_STRATEGY.TIME_FRAME,<br>        ORABET.BT_STRATEGY.PAPER_NO,<br>        1,<br>        1,<br>        -1,<br>        -2,<br>        0,<br>        0,      <br>        ORABET.BT_STRATEGY.BT_STRATEGY_MODULE_ID<br>        FROM ORABET.BT_STRATEGY<br>        INNER JOIN ORABET.BT_PAPERS ON (ORABET.BT_STRATEGY.PAPER_NO = ORABET.BT_PAPERS.PAPER_NO)<br>        where ORABET.BT_STRATEGY.ID = pBT_STRATEGY_ID; <br>              -- параметры<br>              -- удаляем старые параметры и добавляем заново<br>              delete from ORABET.SYS_PARAMS s <br>              where s.STRATEGY_ID = stId;<br>              commit;<br>              insert into ORABET.SYS_PARAMS <br>              (PARAM_NAME, <br>              PARAM_VALUE, <br>              STRATEGY_ID) <br>              (select<br>              ORABET.BT_PARAMS.PARAM_NAME, <br>              nvl(ORABET.BT_PARAMS.VALUEFIXED,0), <br>              stId<br>              from ORABET.BT_PARAMS<br>              where ORABET.BT_PARAMS.STRATEGY_ID = CopyStrategyFromBT.pBT_STRATEGY_ID);   <br>           end;<br>     end if;<br>   -- конец новый    <br>     <br> <br>    <br>    commit;<br> <br> end;  <br> <br> <br> PROCEDURE NewStrategyParam (pStrategy_id in integer, pParam_name in varchar2, pParam_Value in number,  pID OUT integer) is<br> newid integer;<br> begin <br>    newid := ORABET.SYS_PARAMS_SEQ.nextval; <br>    pID := newid; <br>    insert into ORABET.SYS_PARAMS (ORABET.SYS_PARAMS.Id, ORABET.SYS_PARAMS.PARAM_NAME, ORABET.SYS_PARAMS.PARAM_VALUE, ORABET.SYS_PARAMS.STRATEGY_ID)<br>    values (newid, pParam_name, pParam_Value, pStrategy_id);<br>    EXCEPTION<br>         when DUP_VAL_ON_INDEX then<br>         begin<br>            update ORABET.SYS_PARAMS set ORABET.SYS_PARAMS.PARAM_VALUE = pParam_Value where ORABET.SYS_PARAMS.PARAM_NAME = pParam_name and ORABET.SYS_PARAMS.STRATEGY_ID = pStrategy_id; <br>            pID := -1;<br>            COMMIT ;<br>         end;   <br>    <br>    commit;<br> end;<br> <br> PROCEDURE CheckStrategyExists (pBT_STRATEGY_ID in integer, pID OUT integer) is<br> -- CHeck bt_strategy exists in Pseudo_system<br>  newid integer;<br>  StCount integer;<br>  TrName varchar2 (20);<br>  PsName varchar2 (20);<br>  pAsset varchar2 (20);<br>  pTime_frame varchar2 (20);<br>  pPaper_no varchar2 (20);<br>  bstId integer;<br> begin<br>     pId := -1; <br>     StCount := 0; <br>     select ORABET.BT_STRATEGY.TRUE_NAME, ORABET.BT_STRATEGY.PSEUDO_NAME into TrName, PsName<br>     from ORABET.BT_STRATEGY<br>     where ORABET.BT_STRATEGY.ID = pBT_STRATEGY_ID;<br> <br>     select ORABET.PSEUDO_SYSTEM.ID into pId <br>     from ORABET.PSEUDO_SYSTEM<br>     where ORABET.PSEUDO_SYSTEM.TRUE_NAME = TrName and ORABET.PSEUDO_SYSTEM.PSEUDO_NAME = PsName;<br>     EXCEPTION<br>         WHEN NO_DATA_FOUND <br>         THEN begin<br>                pID := -1;<br>                -- ### сделать таблицу логов       <br>                -- ORABET.ALFADIRECT_PACK.SEND_LOG_WHO('ORABET.getAssetByDat','ORABET.ALFADIRECT_PACK.CreateTimeFrameByTicker 209','EXCEPTION Calc OPEN for '||CreateTimeFrameByTicker.ticker||'  NO DATA FOUND', 'ERROR');<br>                --  COMMIT ;<br>              end;   <br>    <br> end;<br>   <br>   <br> END ALFADIRECT_Pack;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{B89BD32E-E5E5-4A0B-95F9-1FC2F81E9BE5}" class="item">
<a name = "Pack_{B89BD32E-E5E5-4A0B-95F9-1FC2F81E9BE5}"></a>
<div class="caption1"><p>ORABET.JTRADE_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> TYPE jt_crs IS REF CURSOR;<br> <br> procedure storeTradersPorfolio(signal in varchar2, signal_date in date, signal_price in number);<br> <br> END JTRADE_PACK;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> TYPE jt_crs IS REF CURSOR;<br> <br>  procedure storeTradersPorfolio(signal in varchar2, signal_date in  date, signal_price in number) is<br>   begin<br>    null;--insert into PAZUZU_TRADERS.TRADERS_PORTFOLIO(id, signal, signal_date, signal_price) values (ORABET.main_seq.nextval, signal, signal_date, signal_price);<br>   end;<br> END JTRADE_PACK;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{AD16D824-565B-4D99-B763-B73B87958DB6}" class="item">
<a name = "Pack_{AD16D824-565B-4D99-B763-B73B87958DB6}"></a>
<div class="caption1"><p>ORABET.MAIL</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br>   procedure getAllMailMailingList(strategy_true_name in varchar2, res out orabet.result_pack.t_crs);<br> END Mail;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS <br>  <br>   PROCEDURE getAllMailMailingList(strategy_true_name IN VARCHAR2,res OUT orabet.Result_Pack.t_crs) IS<br>    BEGIN <br>     OPEN res FOR  <br>         <br>          SELECT NVL(su.mailbox,0) AS mailbox,ml.system_id, <br>          (SELECT NAME FROM orabet.tradecentersections WHERE ID=ml.section_id) AS NAME FROM orabet.sms_mailing_list ml,<br>          XETRADE.system_users su WHERE system_id=(SELECT ID FROM orabet.PSEUDO_SYSTEM WHERE true_name=strategy_true_name)<br> 		 AND ml.user_id=su.ID AND ml.mess_type_id=2;<br>    END;	    <br>          <br>   END Mail;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{A75AC9B1-EFF4-4C36-9CC1-3E51662019DD}" class="item">
<a name = "Pack_{A75AC9B1-EFF4-4C36-9CC1-3E51662019DD}"></a>
<div class="caption1"><p>ORABET.MODELING_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br>  <br>   PROCEDURE  addTradeSignalModelling(strategy_true_name IN VARCHAR2, signal_date IN DATE, signal_price IN NUMBER, signal IN VARCHAR2) ;<br>  <br> END Modeling_Pack;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> PROCEDURE  addTradeSignalModelling(strategy_true_name IN VARCHAR2, signal_date IN DATE, signal_price IN NUMBER, signal IN VARCHAR2) IS<br> sg VARCHAR2(100);<br> sg_id integer;<br> is_resolved integer;<br> rnd integer;<br>  begin<br>  --worked_cancel 0 - не сработал, 1 - сработал, 2 - отменён<br>  select round into rnd from ORABET.pseudo_system where true_name=strategy_true_name;<br>  update ORABET.system_signal2 set id=id where id=(SELECT MAX(ID) FROM ORABET.system_signal2 WHERE strategy_true_name=addTradeSignalModelling.strategy_true_name);<br>  if sql%notfound then <br>               INSERT INTO ORABET.SYSTEM_SIGNAL2 (ID, strategy_true_name, signal_date, signal_price, signal,fact_date, is_stop_active,worked_cancel)<br>                VALUES (ORABET.main_seq.NEXTVAL, strategy_true_name, signal_date, round(signal_price,-rnd), signal, TO_CHAR(SYSDATE, 'yyyymmdd hh24:mi:ss'),0,-1000);<br>          return;        <br>   end if;<br>   <br>           begin<br>             SELECT signal, id INTO sg, sg_id FROM ORABET.system_signal2 WHERE ID = (SELECT MAX(ID) FROM ORABET.system_signal2 WHERE strategy_true_name=addTradeSignalModelling.strategy_true_name);<br>                         IF (LOWER(sg)&lt;&gt;LOWER(signal) AND (LOWER(signal)&lt;&gt;'hold'))  THEN<br>                          if (signal='SetLongStop' or signal='SetShortStop' or signal='NewLongStop' or signal='NewShortStop') then <br>                             update ORABET.SYSTEM_SIGNAL2 set worked_cancel=case when (sg='SetLongStop' or sg='SetShortStop' or sg='NewLongStop' or sg='NewShortStop') then 2 else worked_cancel end, <br>                                                                                                         is_stop_active=case when (sg='SetLongStop' or sg='SetShortStop' or sg='NewLongStop' or sg='NewShortStop') then 0 else is_stop_active end<br>                             where worked_cancel&lt;&gt;1 and id=sg_id; ---сносит все предыдущие сигналы по стратегии, но только если новый сигнал похож на стоп, всем предыдущим стопам ставится признак 2 - отменён, стоп становится неактивным.<br>                          end if;   <br> <br>                          if (signal='SetLongTake' or signal='SetShortTake' or signal='NewLongTake' or signal='NewShortTake') then <br>                             update ORABET.SYSTEM_SIGNAL2 set worked_cancel=case when (sg='SetLongTake' or sg='SetShortTake' or sg='NewLongTake' or sg='NewShortTake') then 2 else worked_cancel end, <br>                                                                                                          is_stop_active=case when (sg='SetLongTake' or sg='SetShortTake' or sg='NewLongTake' or sg='NewShortTake') then 0 else is_stop_active end<br>                             where worked_cancel&lt;&gt;1 and id=sg_id; ---сносит все предыдущие сигналы по стратегии, но только если новый сигнал похож на тейк, всем предыдущим тейкам ставится признак 2 - отменён, стоп становится неактивным.<br>                          end if;   <br>                             <br>                          if (signal='Open Long' or signal='Open Short' or signal='Close Long,Open Short' or signal='Close Short,Open Long' or signal='LongStopCancel' or signal='ShortStopCancel' or signal='LongTakeCancel' or signal='ShortTakeCancel' or signal='Buy' or signal='Sell'<br>                             or signal='StopHasWorkedS' or signal='StopHasWorkedL' or signal='TakeHasWorkedL' or signal='TakeHasWorkedS')  then <br>                             update ORABET.SYSTEM_SIGNAL2 set worked_cancel=2, is_stop_active=0<br>                             where worked_cancel&lt;&gt;1; --сносит все предыдущие сигналы по стратегии, но только если новый сигнал похож на тейк, всем предыдущим тейкам ставится признак 2 - отменён.<br>                                                                   --теперь необходимо обнулять и стопы и тейки при добавлении сигнала, отличающегося от стопа или тейка                            <br>                          end if;<br>                             <br>                             INSERT INTO ORABET.SYSTEM_SIGNAL2 (ID, strategy_true_name, signal_date, signal_price, signal,fact_date, is_stop_active, worked_cancel)<br>                             VALUES (ORABET.main_seq.NEXTVAL, strategy_true_name, signal_date, round(signal_price,-rnd), signal, TO_CHAR(SYSDATE, 'yyyymmdd hh24:mi:ss'),<br>                             case when (signal='Open Long' or signal='Open Short' or signal='Close Long,Open Short' or signal='Close Short,Open Long' or signal='LongStopCancel' or signal='ShortStopCancel' or signal='LongTakeCancel' or signal='ShortTakeCancel' or signal='Buy' or signal='Sell')  then 0 <br>                             when (signal='SetLongStop' or signal='SetShortStop' or signal='NewLongStop' or signal='NewShortStop' or signal='SetLongTake' or signal='SetShortTake' or signal='NewLongTake' or signal='NewShortTake' ) then 1 else -100 end,-1);<br>                             --при добавлении нового сигнала, отличного от стоп или тейк, устанавливается признак is_worked_cancel=0, при добавлении нового сигнала стоп или тейк устанавливается признак 1 - стоп или тейк активны<br> <br>                         end if;<br>           end;              <br>  <br>  <br>   <br>  end; <br>  <br> END Modeling_Pack;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{2132CD51-CD8C-43A9-85FD-07107E69EFBE}" class="item">
<a name = "Pack_{2132CD51-CD8C-43A9-85FD-07107E69EFBE}"></a>
<div class="caption1"><p>ORABET.RESULT_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br> /******************************************************************************<br>    NAME:       result_pack<br>    PURPOSE:<br> <br>    REVISIONS:<br>    Ver        Date        Author           Description<br>    ---------  ----------  ---------------  ------------------------------------<br>    1.0        14/05/2020      alex       1. Created this package.<br> ******************************************************************************/<br> <br>  type t_crs is ref cursor;<br>   PROCEDURE getEmitent(partialName in varchar2, result out orabet.result_pack.t_crs);<br>   Procedure getReleaseTail(release_id in integer, result out orabet.result_pack.t_crs);<br> <br> END result_pack;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> /******************************************************************************<br>    NAME:       result_pack<br>    PURPOSE:<br> <br>    REVISIONS:<br>    Ver        Date        Author           Description<br>    ---------  ----------  ---------------  ------------------------------------<br>    1.0        22.07.2007             1. Created this package body.<br> ******************************************************************************/<br> <br> PROCEDURE getEmitent(partialName in varchar2,result out orabet.result_pack.t_crs) is <br>  begin<br>   null;--open result for select * from dimo.kcb_view where lower (ansi_name) like '%'||lower(partialName)||'%';<br>  end;<br> Procedure getReleaseTail(release_id in integer, result out orabet.result_pack.t_crs) is<br>  begin<br>   null;--open result for select * from dimo.releases_tail where release_id=getReleaseTail.release_id order by value_id;<br>  end; <br> <br> END result_pack;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{7064F493-2FD8-4184-91FF-CA43026CC550}" class="item">
<a name = "Pack_{7064F493-2FD8-4184-91FF-CA43026CC550}"></a>
<div class="caption1"><p>ORABET.SYS_PAR_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> procedure getTEMAParams(strategy_true_name in varchar2, fastTEMA out INTEGER, slowTEMA OUT INTEGER, numperiods OUT INTEGER);<br> PROCEDURE getIsNeedCreation(strategy_true_name IN VARCHAR2, is_need_creation OUT INTEGER);<br> PROCEDURE getCatalinaParams(strategy_true_name IN VARCHAR2, fastDema OUT INTEGER, slowDema OUT INTEGER);<br> END Sys_Par_Pack;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> PROCEDURE getTEMAParams(strategy_true_name IN VARCHAR2, fastTema OUT INTEGER, slowTema OUT INTEGER, numperiods OUT INTEGER) IS<br> s_id INTEGER;<br>  BEGIN<br>   SELECT ID INTO s_id FROM ORABET.PSEUDO_SYSTEM WHERE LOWER(true_name)=LOWER(strategy_true_name);<br>             <br>   SELECT TO_NUMBER(param_value) INTO fastTema FROM ORABET.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('fastperiod');<br>              <br>   SELECT TO_NUMBER(param_value) INTO slowTema FROM ORABET.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('slowperiod');<br>  -- SELECT TO_NUMBER(param_value) INTO numperiods FROM ORABET.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('numperiods');<br> <br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                fastTema := -1;<br>                slowTema := -1;<br>              end;<br>   <br>  END; <br> <br> PROCEDURE getIsNeedCreation(strategy_true_name IN VARCHAR2, is_need_creation OUT INTEGER) IS<br> s_id INTEGER;<br>  BEGIN<br>   SELECT ORABET.pseudo_system.is_need_creation   INTO is_need_creation FROM ORABET.PSEUDO_SYSTEM WHERE LOWER(true_name)=LOWER(strategy_true_name);<br>   --SELECT TO_NUMBER(param_value) INTO is_need_creation FROM ORABET.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('is_need_creation');<br>  END;<br>  <br> PROCEDURE getCatalinaParams(strategy_true_name IN VARCHAR2, fastDema OUT INTEGER, slowDema OUT INTEGER) IS<br> s_id INTEGER;<br>  BEGIN<br>   SELECT ID INTO s_id FROM orabet.PSEUDO_SYSTEM WHERE LOWER(true_name)=LOWER(strategy_true_name);<br>   SELECT TO_NUMBER(param_value) INTO fastDema FROM orabet.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('fastDema');<br>   SELECT TO_NUMBER(param_value) INTO slowDema FROM orabet.sys_params WHERE strategy_id=s_id AND LOWER(param_name)=LOWER('slowDema');<br>     EXCEPTION<br>         WHEN OTHERS <br>         THEN begin<br>                fastDema := -1;<br>                slowDema := -1;<br>              end;<br> <br> <br>  END;<br> <br>  <br> END Sys_Par_Pack;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{51866477-6623-4014-A3F1-044FE0360789}" class="item">
<a name = "Pack_{51866477-6623-4014-A3F1-044FE0360789}"></a>
<div class="caption1"><p>ORABET.SYSTEM_SERV</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br> /******************************************************************************<br>    NAME:       SYSTEM_SERV<br>    PURPOSE:<br> <br>    REVISIONS:<br>    Ver        Date        Author           Description<br>    ---------  ----------  ---------------  ------------------------------------<br>    1.0        26.09.2007             1. Created this package.<br> ******************************************************************************/<br>   PROCEDURE addSignal(strategy_id in integer, strategy_name in varchar2,signal in varchar2,num_lots in integer,<br>   price in number, emitent in varchar2,activ_date in date,exec_price_date in date,paper_no in varchar2,treaty in varchar2,direct_date in date);<br>   procedure getEmitentByPaperNo(paper_no in varchar2,emitent out varchar2);<br>   procedure getTickerByPaperNo(paper_no in varchar2,ticker out varchar2);<br>   procedure addStrategy(strategy_name in varchar2,par1 in varchar2,par2 in varchar2,par3 in varchar2,par4 in varchar2,par5 in varchar2,<br>   capital_part in varchar2);<br> <br> END SYSTEM_SERV;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br>   <br>   PROCEDURE addSignal(strategy_id IN INTEGER, strategy_name IN VARCHAR2, signal IN VARCHAR2,num_lots IN INTEGER,<br>   price IN NUMBER, emitent IN VARCHAR2, activ_date IN DATE,exec_price_date IN DATE,paper_no IN VARCHAR2,treaty IN VARCHAR2,direct_date IN DATE) IS<br>   sig VARCHAR2(10);<br>    BEGIN<br>     <br>     SELECT signal INTO sig <br>     FROM orabet.SYSTEM_SIGNAL <br>     WHERE strategy_name=addSignal.strategy_name AND ID=  (SELECT MAX(ID) FROM orabet.SYSTEM_SIGNAL WHERE strategy_name=addSignal.strategy_name);<br> 	<br>     IF (sig&lt;&gt;signal) or (sig='') or (sig is null)THEN<br>     INSERT INTO orabet.SYSTEM_SIGNAL(ID,strategy_id,strategy_name,signal,num_lots, price,emitent,signal_date,is_sended,activ_date,is_executed,exec_price_date,paper_no,is_blocked,treaty,direct_date) <br>                              VALUES (orabet.main_seq.NEXTVAL,strategy_id,addSignal.strategy_name,addSignal.signal,addSignal.num_lots,addSignal.price,addSignal.emitent,SYSDATE,0,activ_date,0,addSignal.exec_price_date,addSignal.paper_no,0,treaty,direct_date);<br> 	END IF;<br>     <br>    END;<br>    <br>    <br>   PROCEDURE getEmitentByPaperNo(paper_no IN VARCHAR2, emitent OUT VARCHAR2) IS<br>    BEGIN<br>     SELECT ac.p_name INTO emitent FROM orabet.actives ac, orabet.papers p WHERE ac.p_code=p.p_code AND p.paper_no=<br> 	getEmitentByPaperNo.paper_no;<br>    END; <br>    <br>   PROCEDURE addStrategy(strategy_name IN VARCHAR2,par1 IN VARCHAR2,par2 IN VARCHAR2,par3 IN VARCHAR2,par4 IN VARCHAR2,par5 IN VARCHAR2 ,capital_part IN VARCHAR2) IS<br>    tid INTEGER;<br>    BEGIN   <br>     INSERT INTO orabet.STRATEGY_TYPES(ID,NAME)<br> 	 VALUES (orabet.main_seq.NEXTVAL,strategy_name) RETURNING ID INTO tid;<br> 	COMMIT;<br> 	INSERT INTO orabet.STRATEGY_INIT (ID,par1,par2,par3,par4,par5,capital_part,strategy_id)<br> 	 VALUES (orabet.main_seq.NEXTVAL,par1,par2,par3,par4,par5,capital_part,tid);<br> 	COMMIT;   <br>    END; <br>  <br>  PROCEDURE getTickerByPaperNo(paper_no IN VARCHAR2,ticker OUT VARCHAR2) IS<br>   BEGIN<br>    SELECT p_code INTO ticker FROM orabet.papers WHERE paper_no=getTickerByPaperNo.paper_no; <br>   END;  <br> END System_Serv;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
<div id="Pack_{96375814-F116-42D1-8243-A4CD1D5CEA61}" class="item">
<a name = "Pack_{96375814-F116-42D1-8243-A4CD1D5CEA61}"></a>
<div class="caption1"><p>ORABET.TRADE_PACK</p></div>
<table class="tabformat" border="0" cellpadding="2" cellspacing="1" width="100%">
<tr>
<td class="tabhead" width="10%">Specification</td>
<td class="tabdata" width="90%"><pre><code>AS<br>     PROCEDURE  addTradeSignal(strategy_true_name IN VARCHAR2, signal_date IN DATE, signal_price IN NUMBER, signal IN VARCHAR2, signal_price_ready OUT NUMBER);<br> END Trade_Pack;</code></pre></td>
</tr>
<tr>
<td class="tabhead" width="10%">Body Definition</td>
<td class="tabdata" width="90%"><pre><code>AS<br> <br> PROCEDURE  addTradeSignal(strategy_true_name IN VARCHAR2, signal_date IN DATE, signal_price IN NUMBER, signal IN VARCHAR2, signal_price_ready OUT NUMBER) IS<br>    sg VARCHAR2(10); <br>    is_resolved integer;<br>    rnd integer;<br>    hr integer;<br>    mint integer;<br>    my_price number;<br>    maxid integer;<br>  BEGIN<br> <br>   signal_price_ready := -1;<br>   <br>   SELECT EXTRACT (HOUR FROM SYSTIMESTAMP)+3, EXTRACT (MINUTE FROM SYSTIMESTAMP) into hr, mint from dual;<br>   my_price:=signal_price;<br>   <br>   if ((hr&gt;=18) and (mint&gt;=15) and lower(signal)='buy') then my_price:=signal_price*1.005;<br>   end if;<br>   <br>   if ((hr&gt;=18) and (mint&gt;=15) and lower(signal)='sell') then my_price:=signal_price*0.995;<br>   end if;<br>   <br>   select signal_resolved into is_resolved from ORABET.pseudo_system where true_name=strategy_true_name;<br>   if is_resolved=0 then return; end if;<br>   <br> -- ### never used  <br>   select value into is_resolved from orabet.signal_is_resolved;<br> -- ### <br>   select round into rnd from ORABET.pseudo_system where true_name=strategy_true_name;<br> -- insert into bcs.log (id,value) values (ORABET.main_seq.nextval, 'is_resolved is '||is_resolved||' '||sysdate);<br>   commit;<br>  <br>  if is_resolved=1 <br>  then<br>              --INSERT INTO ORABET.system_signal2_par (ID,strategy_true_name,signal_date,signal_price,signal)<br>              --VALUES (ORABET.main_seq.NEXTVAL,strategy_true_name,signal_date,signal_price,signal);<br>     <br>      <br>     SELECT MAX(ID) into maxid <br>     FROM ORABET.system_signal2 <br>     WHERE strategy_true_name=addTradeSignal.strategy_true_name;<br>     <br>     if not (maxid is null) <br>     then           <br>        SELECT signal INTO sg <br>        FROM ORABET.system_signal2 <br>        WHERE ID = (SELECT MAX(ID) FROM ORABET.system_signal2 WHERE strategy_true_name=addTradeSignal.strategy_true_name);<br>        <br>        IF (LOWER(sg)&lt;&gt;LOWER(signal)) AND (LOWER(signal)&lt;&gt;'hold') AND (TRUNC(signal_date,'dd')=TRUNC(SYSDATE,'dd')) <br>        THEN <br>          INSERT INTO ORABET.SYSTEM_SIGNAL2 (ID, strategy_true_name, signal_date, signal_price, signal,fact_date) <br>          VALUES (ORABET.main_seq.NEXTVAL, strategy_true_name, signal_date, round(my_price,-rnd), signal, TO_CHAR(SYSDATE, 'yyyymmdd hh24:mi:ss'));<br>          UPDATE ORABET.last_signal SET last_signal=signal, last_signal_date=signal_date  WHERE true_name = strategy_true_name;<br>          signal_price_ready :=round(my_price,-rnd);<br>        END IF;<br>     else<br>          INSERT INTO ORABET.SYSTEM_SIGNAL2 (ID, strategy_true_name, signal_date, signal_price, signal,fact_date) <br>          VALUES (ORABET.main_seq.NEXTVAL, strategy_true_name, signal_date, round(my_price,-rnd), signal, TO_CHAR(SYSDATE, 'yyyymmdd hh24:mi:ss'));<br>          UPDATE ORABET.last_signal SET last_signal=signal, last_signal_date=signal_date  WHERE true_name = strategy_true_name; <br>           signal_price_ready :=round(my_price,-rnd);  <br>     end if;   <br>  <br>  IF SQL%NOTFOUND <br>  THEN INSERT INTO ORABET.last_signal (ID, true_name, last_signal, last_signal_date) VALUES (ORABET.main_seq.NEXTVAL, strategy_true_name, signal, signal_date);   <br>  END IF;<br> <br> end if;<br> END;<br>  <br> END Trade_Pack;</code></pre></td>
</tr>
</table>
<br>
<div class="itemEnd"><p>&nbsp;</p></div></div>
</div><div id="footer"><div class="pageFooter">Copyright &copy; Sitename 2005</div><div class="footerEnd"><p></p></div></div></div></div></body></html>
